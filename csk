#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_PATH="$(readlink -f "$0")"
if [ -n "${SCRIPT_PATH}" ]; then
  SCRIPT_DIR="$(cd -- "$(dirname -- "${SCRIPT_PATH}")" && pwd)"
fi

# Default root should be the directory where command is run by user.
# If command is run from inside the toolkit checkout itself, route state
# to its parent directory by default.
WORKDIR="$(pwd -P)"
REPO_ROOT="${WORKDIR}"
if [ "${CSK_TOOLKIT_LOCAL_ROOT:-0}" != "1" ] \
  && [ "${REPO_ROOT}" = "${SCRIPT_DIR}" ] \
  && [ -d "${SCRIPT_DIR}/engine/python" ] \
  && [ -f "${SCRIPT_DIR}/README.md" ]; then
  REPO_ROOT="$(cd -- "${SCRIPT_DIR}/.." && pwd -P)"
fi

STATE_ROOT="${CSK_STATE_ROOT:-${REPO_ROOT}}"

export PYTHONPATH="${SCRIPT_DIR}/engine/python${PYTHONPATH:+:${PYTHONPATH}}"
exec python -m csk_next.cli.main --root "${REPO_ROOT}" --state-root "${STATE_ROOT}" "$@"
